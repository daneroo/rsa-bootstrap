<html>
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
<title>Javascript RSA - Login Test</title>
<script type="text/javascript" src="js/hex.js"></script>
<script type="text/javascript" src="js/base64.js"></script>
<script type="text/javascript" src="js/asn1.js"></script>
<!-- <script type="text/javascript" src="js/jsbn.js"></script>
<script type="text/javascript" src="js/jsbn2.js"></script>
<script type="text/javascript" src="js/rsa.js"></script>
<script type="text/javascript" src="js/rsa2.js"></script>
<script type="text/javascript" src="js/sha1.js"></script> -->
<script type="text/javascript">

function asn1decode() {
    var private_pem = document.getElementById("private_key").value;
    //console.log("private_pem:",private_pem);
    console.log("private_pem: ...");
    decodePEM(private_pem);
}

var reHex = /^\s*(?:[0-9A-Fa-f][0-9A-Fa-f]\s*)+$/;
function decodePEM(pem) {
    try {
        var der = reHex.test(pem)
        ? Hex.decode(pem)
        : Base64.unarmor(pem);
        decode(der);
    } catch (e) {
        console.log(e);
    }
    return false;
}

function decode(der) {
    try {
        var asn1 = ASN1.decode(der);
        console.log(asn1);
        console.log(asn1.toPrettyString());
        hexFields=[];
        for (var i=0;i<asn1.sub.length;i++){
            var f = asn1.sub[i];
            //console.log(f);
            console.log(f.toPrettyString());
            console.log('header:',f.header,f.stream.hexDump(f.stream.pos,f.stream.pos+f.header));
            console.log('hex:',fieldAsHex(f));
            //console.log('hex2:',fieldAsHex2(f));
            hexFields.push(fieldAsHex(f));
        }
        for (var i=0;i<hexFields.length;i++){
            console.log(i,hexFields[i]);
        }
        var rsa_private = {
            unused : hexFields[0],
            n : hexFields[1],
            e : hexFields[2],
            d : hexFields[3],
            p : hexFields[4],
            q : hexFields[5],
            dmp1 : hexFields[6],
            dmq1 : hexFields[7],
            coef : hexFields[8]
        }
        console.log(rsa_private);
    } catch (e) {
        console.log(e);
    }
    return false;
}

function fieldAsHex(f){
    var start=f.stream.pos+f.header;
    var end=f.stream.pos+f.header+f.length;
    var enc = f.stream.enc.slice(start,end);
    var s = "";
    for (var i = 0; i < enc.length; ++i) {
        s += f.stream.hexByte(enc[i]);
    }
    return s;
}

// not done see decoder example    
function fieldAsHex2(f){
    var start=f.stream.pos+f.header;
    var end=f.stream.pos+f.header+f.length;
    var enc = f.stream.enc.slice(start,end);
    var chars = "";
    for (var i = 0; i < enc.length; ++i) {
        chars += String.fromCharCode(enc[i]);
    }
    console.log('chars',chars);
    var h = enc.toString(16);
    if ((h.length & 1) == 0) return h; else return "0" + h;
}
    

function assemble() {
var password_field = document.getElementById("password");
var data_field = document.getElementById("data");
data_field.value=sha1(password_field.value) + (new Date().getTime());
}
function encrypt() {
var login_field = document.getElementById("login");
var data_field = document.getElementById("data");
login_field.value=RSA.encrypt(data_field.value, $key);
}
</script>

</head>

<body>

<h1>Javascript RSA - Decode</h1>

This test is an example to perform user login using javascript RSA. <br/>
<ol>
<li>The user type in E-mail as username and a password.</li>
<li>The client-side javascript hashes the password using SHA-1.</li>
<li>The client-side javascript attach a timestamp to the end of the hash.</li>
<li>The client-side javascript encrypt the whole thing with the RSA public key.</li>

<li>The browser submits the encrypted data.</li>
</ol>

<strong>For testing purpose, the credential to login is any E-mail with the password "test".</strong><br/><br/>

<form action="login.php" method="post">
Private Key:<br/>
<textarea id="private_key" cols="50" rows="10"></textarea><br/>
<input type="button" onclick="asn1decode()" value="0. ASN1.decode"/><br/>

Email:<br/>
<input name="email" type="text" size="40"/><br/>
Password:<br/>
<input id="password" type="password" size="40"/><br/>
<input type="button" onclick="assemble()" value="1. Assemble"/><br/>
<textarea id="data" readonly="readonly" cols="50" rows="2"></textarea><br/>
<input type="button" onclick="encrypt()" value="2. Encrypt"/><br/>

<textarea id="login" name="login" readonly="readonly" cols="50" rows="10"></textarea><br/>

<input name="submit" type="submit" value="3. Login" size="10"/>
</form>
</body>

</html>
